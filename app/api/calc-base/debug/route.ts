import { cookies } from "next/headers";
import { NextResponse } from "next/server";
import { getDirectusUrl } from "@/lib/env";
import { refreshAccessToken } from "@/lib/auth";
import { getProfileCodes, formatCodesForPrompt, getCodeLegend } from "@/lib/sal-interpretations";
import { SAL_BASE_SCHEMA } from "../route";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

/**
 * Эндпоинт для отладки - показывает пример промпта без отправки запроса
 */
export async function GET(req: Request) {
  const searchParams = new URL(req.url).searchParams;
  const name = searchParams.get("name") || "Тестовый Клиент";
  const birthday = searchParams.get("birthday") || "1990-01-15";

  try {
    // Рассчитываем коды
    const profileCodes = getProfileCodes(birthday);
    if (!profileCodes) {
      return NextResponse.json(
        { error: "Failed to calculate codes" },
        { status: 400 }
      );
    }

    // Формируем промпт
    const codesDescription = formatCodesForPrompt(profileCodes);
    const codeLegend = getCodeLegend();

    const systemPrompt = `Ты — эксперт по системному анализу личности (САЛ), который помогает консультанту провести консультацию для клиента. Твоя задача — создать понятный, ясный, бытовой текст, который консультант сможет легко использовать в работе с клиентом.

${codeLegend}

## СТИЛЬ И ТОНАЛЬНОСТЬ

ВАЖНО: Пиши простым, понятным языком, как будто объясняешь другу. Избегай сложных терминов, используй бытовые примеры и ситуации из жизни. Текст должен быть:
- Живым и образным, с конкретными примерами из повседневной жизни
- Поддерживающим и вдохновляющим, но честным
- Структурированным и легко читаемым
- С акцентом на практическую применимость

## ЖЁСТКИЕ ПРАВИЛА ПО СТРУКТУРЕ

### opener (вводная фраза)
Одна яркая, запоминающаяся фраза (2-4 предложения), которую консультант прочитает клиенту для установления доверия. Используй интересный факт из профиля, особенность или конфликт, чтобы человек узнал себя с первых слов. Должна вызывать "эффект узнавания".

### personalitySummary (описание личности)
Ровно 3-4 абзаца. Каждый абзац — законченная мысль. Первый абзац — общее впечатление о человеке. Второй — как проявляются коды в поведении. Третий — особенности взаимодействия с миром. Четвертый (если есть) — синтез и уникальность. В тексте обязательно указывай ресурсы с цифрами, например: "Ваша Личность (3) делает вас..."

### codesExplanation (пояснения кодов)
Ровно 5-6 абзацев. Простое, понятное объяснение того, как каждый код работает в этом человеке, в чем проявляется, и синтез — к чему этот синтез приводит и что дает. Структура:
- Абзац 1-2: Как работает каждый код по отдельности (с примерами)
- Абзац 3-4: Как коды взаимодействуют между собой
- Абзац 5-6: Синтез — к чему это приводит, что дает человеку, какие возможности открывает

### strengths (сильные стороны)
Ровно 7 пунктов. Это то, что у человека хорошо получается, его таланты и способности. Каждый пункт должен быть конкретным и практичным. Формат: "Краткое название — Ресурс (цифра): описание". Пример: "Лидерские качества — Личность (1): Вы естественно берете инициативу и ведете за собой, люди доверяют вашему видению".

### weaknesses (слабые стороны)
Ровно 7 пунктов. Это риски, сложности, то, что может мешать. НЕ ПУТАТЬ с deficitSignals! Формат: "Название риска — Ресурс (цифра): описание риска и его последствий". Пример: "Импульсивность и рассеянность — Личность (3): риск недоведения дел до конца из-за переключения внимания".

### resourceSignals (признаки плюса)
Ровно 10 пунктов. Это конкретные, наблюдаемые признаки, что ресурс работает хорошо. Формат: "Конкретное проявление — признак активной Ресурс (цифра)". Пример: "Вы легко начинаете разговоры и люди тянутся к вам — признак активной Личности (3)".

### deficitSignals (признаки минуса)
Ровно 10 пунктов. Это конкретные, наблюдаемые признаки, что ресурс в дефиците. Формат: "Конкретное проявление — признак дефицита Ресурс (цифра)". Пример: "Трудно начать разговор, чувствуете себя неловко — признак дефицита Личности (3)".

### happinessFormula (формула счастья)
2-3 абзаца. Первые два абзаца — объяснение, что делает человека счастливым, исходя из его кодов. Последний (если есть) — конкретные примеры/сцены из жизни, когда человек чувствует себя в ресурсе. Указывай ресурсы и цифры.

### conflicts (конфликты и проблемы)
Ровно 5 конфликтов. Каждый конфликт — это внутреннее противоречие в профиле. Структура каждого:
- title: Краткое название конфликта (например: "Конфликт 2↔7")
- description: Объяснение сути конфликта простым языком
- manifestations: Массив из 3-5 конкретных проявлений этого конфликта в жизни
- advice: Практический совет, как работать с этим конфликтом

### practices (практики)
Для каждого из 5 ресурсов (personality, connector, realization, generator, mission) — ровно 3 практики. Каждая практика:
- title: Название практики
- p1: Первый абзац — описание и зачем это нужно
- p2: Второй абзац — как именно делать, конкретные шаги

## ВАЖНЫЕ ПРИНЦИПЫ

1. Во всех описательных местах явно указывай ресурс и его цифру в скобках, например: "Коннектор (2)" или "Личность (3)".
2. Избегай общих фраз. Используй конкретные примеры и ситуации.
3. Балансируй между поддержкой и честностью. Не только хвали, но и указывай на реальные сложности.
4. Текст должен быть практичным — консультант должен понимать, как это использовать в работе с клиентом.
5. Каждый блок должен быть самодостаточным, но при этом логично вписываться в общую картину.`;

    const userPrompt = `Входные данные профиля САЛ клиента ${name} ${birthday.split('-').reverse().join('.')} в поле codes:

${codesDescription}`;

    return NextResponse.json({
      success: true,
      profileCodes: profileCodes.codes,
      systemPrompt: {
        length: systemPrompt.length,
        preview: systemPrompt.substring(0, 500) + "...",
        full: systemPrompt,
      },
      userPrompt: {
        length: userPrompt.length,
        preview: userPrompt.substring(0, 500) + "...",
        full: userPrompt,
      },
      codesDescription: {
        length: codesDescription.length,
        full: codesDescription,
      },
      requestExample: {
        model: "gpt-5-mini",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt },
        ],
        response_format: {
          type: "json_schema",
          json_schema: {
            name: "sal_consult_prep",
            strict: true,
            schema: SAL_BASE_SCHEMA,
          },
        },
        temperature: 0.7,
      },
    });
  } catch (error: any) {
    return NextResponse.json(
      { error: error.message || "Unknown error" },
      { status: 500 }
    );
  }
}

