import { NextRequest, NextResponse } from "next/server";
import { getDirectusUrl } from "@/lib/env";
import { logger } from "@/lib/logger";

/**
 * Получает токен для работы с Directus
 */
function getDirectusToken(): string | null {
  const serviceToken = process.env.DIRECTUS_SERVICE_TOKEN;
  if (serviceToken) {
    return serviceToken;
  }
  logger.warn("DIRECTUS_SERVICE_TOKEN not set");
  return null;
}

export async function GET(req: NextRequest) {
  const baseUrl = getDirectusUrl();
  if (!baseUrl) {
    return NextResponse.json({ message: "No DIRECTUS_URL configured" }, { status: 500 });
  }

  const token = getDirectusToken();
  if (!token) {
    return NextResponse.json({ message: "Service token not configured" }, { status: 500 });
  }

  try {
    const { searchParams } = new URL(req.url);
    const testToken = searchParams.get("token");

    if (!testToken) {
      return NextResponse.json({ message: "token parameter is required" }, { status: 400 });
    }

    // Валидация формата UUID
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(testToken)) {
      return NextResponse.json({ message: "Invalid token format" }, { status: 400 });
    }

    // Проверяем токен в test_tokens (добавлено поле request_birth_date)
    const tokenRes = await fetch(`${baseUrl}/items/test_tokens?filter[token][_eq]=${testToken}&fields=id,token,client_id,test_id,used,expires_at,request_birth_date`, {
      headers: { Authorization: `Bearer ${token}`, Accept: "application/json" },
      cache: "no-store"
    });

    if (!tokenRes.ok) {
      return NextResponse.json({ message: "Failed to verify token" }, { status: 500 });
    }

    const tokenData = await tokenRes.json().catch(() => ({ data: [] }));
    const tokenRecord = tokenData?.data?.[0];

    if (!tokenRecord) {
      return NextResponse.json({ message: "Invalid token" }, { status: 404 });
    }

    if (tokenRecord.used) {
      return NextResponse.json({ message: "Token already used", used: true }, { status: 400 });
    }

    // Проверяем срок действия токена (если установлен)
    if (tokenRecord.expires_at) {
      const expiresAt = new Date(tokenRecord.expires_at);
      if (expiresAt < new Date()) {
        return NextResponse.json({ message: "Token expired", expired: true }, { status: 400 });
      }
    }

    // Получаем информацию о клиенте (только имя)
    const clientRes = await fetch(`${baseUrl}/items/clients/${tokenRecord.client_id}?fields=id,name`, {
      headers: { Authorization: `Bearer ${token}`, Accept: "application/json" },
      cache: "no-store"
    });

    let clientName = null;
    if (clientRes.ok) {
      const clientData = await clientRes.json().catch(() => ({ data: {} }));
      clientName = clientData?.data?.name || null;
    }

    return NextResponse.json({
      valid: true,
      testId: tokenRecord.test_id,
      clientId: tokenRecord.client_id,
      clientName,
      requestBirthDate: Boolean(tokenRecord.request_birth_date) // НОВОЕ: возвращаем флаг
    });
  } catch (error) {
    logger.error("Error verifying token:", error);
    return NextResponse.json(
      { message: "Error verifying token", error: String(error) },
      { status: 500 }
    );
  }
}
