# Реализация детского расчета САЛ

## Обзор

Детский расчет добавлен в систему серверной генерации консультаций. Он предназначен для родителей, которые хотят получить рекомендации по воспитанию, обучению и развитию ребенка на основе кодов САЛ.

## Реализованные компоненты

### 1. Промпт для детского расчета

**Файл:** `от меня /промпты в n8n/детский.json`

Промпт включает:
- Системное сообщение с инструкциями для генерации детской консультации
- Поддержка опционального запроса родителей
- JSON Schema для структурированного ответа
- Модель: gpt-5-mini с reasoning effort: medium

### 2. Типы и интерфейсы

**Файл:** `lib/sal-generation.ts`

Добавлено:
- `ConsultationType` расширен типом `"child"`
- `ChildCalculationInput` интерфейс для входных данных детского расчета
- `generateChildConsultation()` функция для генерации детской консультации
- `createChildUserPrompts()` функция для формирования промптов (два сообщения)

### 3. Валидация

**Файл:** `lib/consultation-validator.ts`

Добавлено:
- `validateChildConsultation()` функция для валидации детского расчета
- Проверка всех обязательных полей
- Проверка длин массивов согласно схеме
- Интеграция в общую функцию `validateConsultation()`

### 4. Загрузка промптов

**Файл:** `lib/prompt-loader.ts`

Обновлено:
- Поддержка типа `"child"` во всех функциях
- Загрузка файла `детский.json`

### 5. API Endpoints

**Файлы:** `app/api/calc-server/route.ts`, `app/api/calc/route.ts`

Добавлено:
- Поддержка типа `"child"` в обоих endpoints
- Валидация входных данных
- Обработка опционального запроса родителей
- Генерация и сохранение детской консультации

## Структура результата

Детская консультация содержит следующие разделы:

1. **opener** (string) - вводная фраза для родителей
2. **childPotential** (array, 3-5) - потенциал ребенка
3. **developmentFeatures** (array, 5-7) - особенности развития
4. **upbringingRecommendations** (array, 7-10) - рекомендации по воспитанию
5. **educationalApproach** (array, 5-7) - подход к обучению
6. **communicationStyle** (array, 3-5) - стиль общения
7. **challengesAndSolutions** (array, 5-7) - вызовы и решения
8. **activitiesAndHobbies** (array, 5-7) - активности и хобби
9. **parentChildInteraction** (array, 3-5) - взаимодействие родитель-ребенок
10. **futureProspects** (array, 2-3) - перспективы будущего

## Использование

### Общий детский расчет (без запроса)

```bash
POST /api/calc
Content-Type: application/json

{
  "name": "Анна",
  "birthday": "2015-03-20",
  "type": "child",
  "clientId": 123,
  "gender": "female"
}
```

### Детский расчет с запросом родителей

```bash
POST /api/calc
Content-Type: application/json

{
  "name": "Анна",
  "birthday": "2015-03-20",
  "type": "child",
  "request": "Ребенок очень активный, не может усидеть на месте, как помочь ему сконцентрироваться?",
  "clientId": 123,
  "gender": "female"
}
```

## Особенности реализации

### 1. Опциональный запрос

Запрос родителей (`request`) является опциональным:
- Если указан - учитывается при генерации всех разделов
- Если не указан - генерируется общий детский расчет с полным анализом

### 2. Формирование промптов

Для детского расчета формируются два user сообщения:
1. Первое: "Входные данные профиля САЛ ребенка [имя] [дата] в поле codes:"
2. Второе: "Входные данные профиля САЛ в поле codes: [описания кодов]" + опционально "Запрос родителей: [запрос]"

### 3. Валидация

Валидация проверяет:
- Наличие всех обязательных полей
- Длины массивов (соответствие min/max)
- Типы данных
- Структуру вложенных объектов

### 4. Сохранение

Результат сохраняется в Directus:
- `raw_json` - полный JSON результат
- `digits` - массив кодов САЛ [personality, connector, realization, generator, mission]

## Интеграция с существующей системой

Детский расчет полностью интегрирован:
- ✅ Использует те же механизмы генерации
- ✅ Поддерживает retry логику
- ✅ Имеет валидацию данных
- ✅ Сохраняется в том же формате
- ✅ Поддерживает детальное логирование

## Тестирование

Для тестирования используйте:

```bash
# Общий детский расчет
curl -X POST http://localhost:3000/api/calc \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тест",
    "birthday": "2015-01-15",
    "type": "child"
  }'

# Детский расчет с запросом
curl -X POST http://localhost:3000/api/calc \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тест",
    "birthday": "2015-01-15",
    "type": "child",
    "request": "Как помочь ребенку сконцентрироваться?"
  }'
```

## Отличия от других типов расчетов

1. **Фокус на родителях** - текст адресован родителям, а не ребенку
2. **Практические рекомендации** - больше внимания к конкретным советам
3. **Опциональный запрос** - можно указать конкретный вопрос родителей
4. **Специальная структура** - адаптирована для детского профиля

## Будущие улучшения

Возможные направления развития:
- Добавление возрастных рекомендаций (учитывать возраст ребенка)
- Интеграция с образовательными программами
- Рекомендации по выбору школы/кружков
- Советы по развитию конкретных навыков

