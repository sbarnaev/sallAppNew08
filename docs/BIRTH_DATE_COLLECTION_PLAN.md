# План реализации сбора даты рождения через тесты

## Цель
Добавить возможность запрашивать имя и дату рождения у клиентов перед завершением теста для целей информированного согласия и САЛ расчета.

## Архитектура решения

### 1. База данных (Directus)

**Обновление коллекции `test_tokens`:**
- Добавить поле `request_birth_date` (boolean, default: false) - флаг, нужно ли запрашивать данные
- Поля `client_name` и `birth_date` НЕ добавляем, т.к. данные будут обновляться напрямую в таблице `clients`

### 2. API изменения

#### `/api/tests/generate-link` (POST)
**Входящие данные:**
```json
{
  "clientId": 123,
  "testId": "depression",
  "requestBirthDate": true  // НОВОЕ: опционально
}
```

**Изменения:**
- Принимать `requestBirthDate?: boolean`
- Сохранять в `test_tokens.request_birth_date`

#### `/api/tests/verify-token` (GET)
**Исходящие данные:**
```json
{
  "valid": true,
  "testId": "depression",
  "clientId": 123,
  "clientName": "Иван Иванов",
  "requestBirthDate": true  // НОВОЕ
}
```

**Изменения:**
- Возвращать `requestBirthDate` из записи `test_tokens`

#### `/api/tests/submit-by-token` (POST)
**Входящие данные:**
```json
{
  "testToken": "uuid",
  "result": { ... },
  "clientName": "Иван Иванов",      // НОВОЕ: опционально, если requestBirthDate = true
  "birthDate": "1990-05-15"         // НОВОЕ: опционально, если requestBirthDate = true
}
```

**Изменения:**
- Если `requestBirthDate = true` и переданы `clientName` и `birthDate`:
  - Обновить клиента (`clients.name` и `clients.birth_date`)
- Затем сохранить результат теста как обычно

### 3. UI изменения

#### `components/TestLinkGenerator.tsx`
- Добавить checkbox "Запросить дату рождения"
- При генерации ссылки передавать `requestBirthDate: boolean`

#### `app/test/[token]/page.tsx`
**Новая логика потока:**
1. Пользователь проходит тест (как обычно)
2. После ответа на последний вопрос и нажатия "Завершить":
   - Если `requestBirthDate === true` → показать форму сбора данных
   - Если `requestBirthDate === false` → сохранить результат и показать финальный экран

**Форма сбора данных должна содержать:**
- Текст о необходимости данных для информированного согласия
- Поле "Фамилия и Имя" (required)
- Поле "Дата рождения" (required, date picker)
- Кнопка "Отправить"

**Текст для формы:**
```
Для оказания психологической помощи в соответствии с требованиями 
профессиональной этики нам необходимо получить ваше информированное 
согласие. Пожалуйста, укажите ваши данные:

[Форма]
```

### 4. Скрипт миграции

Создать скрипт `scripts/add-birth-date-field-to-test-tokens.mjs` для добавления поля `request_birth_date` в коллекцию `test_tokens`.

## Порядок реализации

1. ✅ Создать план (этот документ)
2. Создать скрипт миграции для добавления поля в Directus
3. Обновить `/api/tests/generate-link` для поддержки `requestBirthDate`
4. Обновить `/api/tests/verify-token` для возврата `requestBirthDate`
5. Обновить `/api/tests/submit-by-token` для обработки и сохранения данных
6. Обновить `TestLinkGenerator.tsx` - добавить checkbox
7. Обновить страницу теста - добавить форму перед завершением
8. Протестировать полный флоу

## Важные моменты

- **Валидация:** Дата рождения должна быть валидной и разумной (не в будущем, не слишком старый возраст)
- **Конфиденциальность:** Данные обрабатываются через сервисный токен с ограниченными правами
- **UX:** Форма должна быть понятной и не пугающей
- **Обратная совместимость:** Если `requestBirthDate` не указан, поведение должно быть как сейчас
