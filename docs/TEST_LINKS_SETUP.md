# Настройка одноразовых ссылок на психологические тесты

## Описание

Система позволяет создавать одноразовые ссылки для клиентов на прохождение психологических тестов. Клиенты могут пройти тест без авторизации, результат автоматически сохраняется за клиентом.

## Установка

### 1. Создание коллекции test_tokens в Directus

Запустите скрипт для создания коллекции:

```bash
DIRECTUS_URL="https://ваш-directus-url.com" \
DIRECTUS_ADMIN_TOKEN="ваш-админский-токен" \
node scripts/setup-test-tokens.mjs
```

Или используйте переменные окружения для авторизации:

```bash
DIRECTUS_URL="https://ваш-directus-url.com" \
DIRECTUS_ADMIN_EMAIL="admin@example.com" \
DIRECTUS_ADMIN_PASSWORD="ваш-пароль" \
node scripts/setup-test-tokens.mjs
```

### 2. Настройка переменных окружения

Добавьте в `.env.local` или переменные окружения на сервере:

```env
# URL приложения (для генерации ссылок)
NEXT_PUBLIC_APP_URL=https://ваш-домен.com

# Сервисный токен Directus (для публичных API без авторизации)
DIRECTUS_SERVICE_TOKEN=ваш-статический-токен-directus
```

**Важно:** `DIRECTUS_SERVICE_TOKEN` должен быть статическим токеном с правами:
- Чтение коллекции `test_tokens`
- Обновление коллекции `test_tokens` (для пометки использованных токенов)
- Чтение коллекции `clients` (только для проверки существования клиента)
- Обновление коллекции `clients` (для сохранения результатов тестов)

### 3. Настройка прав доступа в Directus

Для коллекции `test_tokens` настройте права:

**Для роли с правами на создание ссылок (например, "master"):**
- Создание записей
- Чтение своих записей

**Для сервисного токена (DIRECTUS_SERVICE_TOKEN):**
- Чтение всех записей (для проверки токена)
- Обновление всех записей (для пометки использованных)

## Использование

### Генерация ссылки

1. Перейдите на страницу клиента или на страницу тестов
2. Выберите клиента (если находитесь на странице тестов)
3. Нажмите "Получить ссылку для клиента" под нужным тестом
4. Скопируйте ссылку и отправьте клиенту

### Публичное прохождение теста

Клиент переходит по ссылке:
- Видит страницу теста без необходимости авторизации
- Проходит тест
- Результат автоматически сохраняется за клиентом
- Токен становится использованным (одноразовая ссылка)

### Просмотр результатов

Результаты теста отображаются в разделе "Результаты тестирования" на странице клиента.

## API Endpoints

### POST /api/tests/generate-link

Генерирует одноразовую ссылку на тест для клиента.

**Требует авторизации:** Да

**Параметры:**
```json
{
  "clientId": 123,
  "testId": "depression"
}
```

**Ответ:**
```json
{
  "success": true,
  "token": "uuid-токена",
  "link": "https://домен.com/test/uuid-токена"
}
```

### GET /api/tests/verify-token

Проверяет валидность токена (используется публичной страницей теста).

**Требует авторизации:** Нет (использует сервисный токен)

**Параметры:**
- `token` (query parameter) - токен ссылки

**Ответ:**
```json
{
  "valid": true,
  "testId": "depression",
  "clientId": 123,
  "clientName": "Имя Клиента"
}
```

### POST /api/tests/submit-by-token

Сохраняет результат теста по токену.

**Требует авторизации:** Нет (использует сервисный токен)

**Параметры:**
```json
{
  "testToken": "uuid-токена",
  "result": {
    "date": "2025-01-XX...",
    "score": 15,
    "level": "high",
    "answers": {...},
    "interpretation": "..."
  }
}
```

**Ответ:**
```json
{
  "success": true,
  "data": {...}
}
```

## Безопасность

- Токены генерируются как UUID v4 (криптографически стойкие)
- Каждый токен можно использовать только один раз
- Токены привязаны к конкретному клиенту и тесту
- Публичные API используют сервисный токен с ограниченными правами
- Проверка прав доступа: только владелец клиента может создавать ссылки

## Структура данных

### Коллекция test_tokens

- `id` (UUID) - первичный ключ
- `token` (UUID) - уникальный токен ссылки
- `client_id` (Integer) - ID клиента
- `test_id` (String) - ID теста (depression, anxiety, etc.)
- `used` (Boolean) - использован ли токен
- `expires_at` (Timestamp, nullable) - срок действия (необязательно)
- `created_at` (Timestamp) - дата создания

## Устранение неполадок

### Ошибка "Service token not configured"

Убедитесь, что `DIRECTUS_SERVICE_TOKEN` установлен в переменных окружения.

### Ошибка "Token already used"

Токен уже был использован для прохождения теста. Создайте новую ссылку.

### Ошибка "Token expired"

Если установлен срок действия токена, он истек. Создайте новую ссылку.

### Ссылка не работает

Проверьте:
1. Правильность `NEXT_PUBLIC_APP_URL` (должен быть без слеша в конце)
2. Что маршрут `/test/[token]` доступен публично
3. Что сервисный токен имеет необходимые права доступа
