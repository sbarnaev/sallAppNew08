# Автоматическая настройка политик доступа в Directus

## Быстрый старт

Скрипт автоматически настраивает все политики доступа для роли "master" в Directus.

### Запуск

```bash
# Вариант 1: С админским токеном
DIRECTUS_URL="https://directus.example.com" \
DIRECTUS_ADMIN_TOKEN="your_admin_static_token" \
npm run setup:directus-permissions

# Вариант 2: С email/паролем
DIRECTUS_URL="https://directus.example.com" \
DIRECTUS_ADMIN_EMAIL="admin@example.com" \
DIRECTUS_ADMIN_PASSWORD="password" \
npm run setup:directus-permissions
```

## Что делает скрипт

### 1. Создаёт роль "master"
- Роль с ID `master` и именем "Master"
- Доступ к приложению (`app_access: true`)
- Без доступа к админке (`admin_access: false`)

### 2. Настраивает permissions для коллекций

#### `clients`
- **Чтение**: только клиенты, где `owner_user = $CURRENT_USER`
- **Создание**: автоматически проставляется `owner_user = $CURRENT_USER`
- **Обновление/Удаление**: только свои клиенты

#### `profiles`
- **Чтение**: только профили, где `owner_user = $CURRENT_USER`
- **Создание**: автоматически проставляется `owner_user = $CURRENT_USER`
- **Обновление/Удаление**: только свои профили

#### `qa`
- **Чтение**: только Q&A для профилей, где `profile_id.owner_user = $CURRENT_USER`
- **Создание/Обновление/Удаление**: только для своих профилей

#### `profile_chunks`
- **Чтение**: только chunks для профилей, где `profile_id.owner_user = $CURRENT_USER`
- **Создание/Обновление/Удаление**: только для своих профилей

### 3. Проверяет настройки токенов
- Декодирует текущий токен
- Показывает время истечения
- Предупреждает, если токен истекает слишком быстро
- Напоминает про настройку `AUTH_TOKEN_TTL` и `AUTH_REFRESH_TOKEN_TTL`

## После запуска

1. **Назначьте пользователей на роль "master"**:
   - В админке Directus: Settings → Roles & Permissions → Master → Users
   - Или через API

2. **Проверьте настройки токенов**:
   - Убедитесь, что в Directus установлены:
     ```env
     AUTH_TOKEN_TTL=259200        # 3 дня
     AUTH_REFRESH_TOKEN_TTL=2592000  # 30 дней
     ```
   - Перезапустите Directus после изменения переменных окружения

3. **Проверьте работу**:
   - Залогиньтесь как пользователь с ролью "master"
   - Убедитесь, что видите только свои данные
   - Попробуйте создать клиента/профиль - должен автоматически проставиться `owner_user`

## Безопасность

- Скрипт идемпотентен: можно запускать многократно
- Не удаляет существующие permissions, только обновляет/создаёт
- Использует фильтры `$CURRENT_USER` для изоляции данных
- Автоматически проставляет `owner_user` при создании записей

## Устранение проблем

### Ошибка "Role not found"
- Убедитесь, что у вас есть админский доступ
- Проверьте правильность токена/email/пароля

### Permissions не применяются
- Проверьте, что пользователь назначен на роль "master"
- Убедитесь, что в коллекциях есть поле `owner_user`
- Проверьте логи Directus

### Токены всё равно истекают быстро
- Установите `AUTH_TOKEN_TTL` и `AUTH_REFRESH_TOKEN_TTL` в переменных окружения Directus
- Перезапустите Directus
- Проверьте, что переменные действительно применились

