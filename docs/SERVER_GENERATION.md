# Серверная генерация консультаций САЛ

## Обзор

Система серверной генерации консультаций заменяет зависимость от n8n и выполняет всю генерацию непосредственно на сервере. Это обеспечивает:

- **Независимость от внешних сервисов** - не требуется n8n
- **Стабильность** - все операции выполняются на сервере
- **Отказоустойчивость** - встроенная retry логика и обработка ошибок
- **Масштабируемость** - поддержка множественных одновременных запросов

## Архитектура

### Компоненты

1. **lib/prompt-loader.ts** - загрузка промптов из JSON файлов
2. **lib/sal-generation.ts** - основная логика генерации консультаций
3. **app/api/calc-server/route.ts** - новый endpoint для серверной генерации
4. **app/api/calc/route.ts** - обновленный endpoint с поддержкой серверной генерации
5. **app/api/calc-base/route.ts** - обновленный endpoint с поддержкой серверной генерации

### Типы консультаций

- **base** - базовый расчет (базовый.json)
- **target** - целевой расчет (целевой.json)
- **partner** - партнерский расчет (партнерский.json)
- **child** - детский расчет (детский.json) - общий или с запросом родителей

## Настройка

### Переменные окружения

```env
# Обязательно
OPENAI_API_KEY=sk-... # Ключ OpenAI API

# Опционально
USE_SERVER_GENERATION=true # Использовать серверную генерацию (по умолчанию true)
N8N_CALC_URL=... # URL n8n для fallback (опционально)
```

### Включение/отключение

По умолчанию серверная генерация включена. Для отключения установите:

```env
USE_SERVER_GENERATION=false
```

При отключении система будет использовать n8n (если настроен N8N_CALC_URL).

## Использование

### Базовый расчет

```typescript
POST /api/calc-base
{
  "name": "Иван",
  "birthday": "1990-01-15",
  "clientId": 123,
  "gender": "male"
}
```

### Целевой расчет

```typescript
POST /api/calc
{
  "name": "Иван",
  "birthday": "1990-01-15",
  "type": "target",
  "request": "Хочу улучшить отношения с коллегами",
  "clientId": 123
}
```

### Партнерский расчет

```typescript
POST /api/calc
{
  "name": "Иван",
  "birthday": "1990-01-15",
  "type": "partner",
  "partnerName": "Мария",
  "partnerBirthday": "1992-05-20",
  "goal": "Хотим улучшить отношения",
  "clientId": 123
}
```

### Детский расчет

#### Общий детский расчет (без запроса)

```typescript
POST /api/calc
{
  "name": "Анна",
  "birthday": "2015-03-20",
  "type": "child",
  "clientId": 123
}
```

#### Детский расчет с запросом родителей

```typescript
POST /api/calc
{
  "name": "Анна",
  "birthday": "2015-03-20",
  "type": "child",
  "request": "Ребенок очень активный, не может усидеть на месте, как помочь ему сконцентрироваться?",
  "clientId": 123
}
```

## Обработка ошибок

Система включает:

1. **Retry логика** - до 3 попыток при ошибках сервера (5xx)
2. **Таймауты** - 120 секунд на запрос к API
3. **Fallback на n8n** - если серверная генерация не удалась и настроен n8n
4. **Детальное логирование** - все ошибки логируются для отладки

## Формат ответа API

Система поддерживает несколько форматов ответа от OpenAI API:

1. **gpt-5-mini** - специальный endpoint `/v1/responses` с форматом `{ output: ... }`
2. **Стандартный OpenAI** - endpoint `/v1/chat/completions` с форматом `{ choices: [...] }`
3. **JSON Schema** - структурированные ответы согласно схеме из промптов

## Сохранение результатов

Результаты сохраняются в Directus в профиль:

- `raw_json` - полный JSON результат генерации
- `digits` - массив кодов САЛ [personality, connector, realization, generator, mission]
- `base_profile_json` - для базового расчета (дубликат raw_json)

## Логирование

Все операции логируются с префиксами:

- `[SAL-GENERATION]` - генерация консультаций
- `[PROMPT-LOADER]` - загрузка промптов
- `[CALC-SERVER]` - серверный endpoint
- `[CALC]` - основной endpoint
- `[CALC-BASE]` - базовый endpoint

## Тестирование

Для тестирования используйте:

```bash
# Базовый расчет
curl -X POST http://localhost:3000/api/calc-base \
  -H "Content-Type: application/json" \
  -d '{"name": "Тест", "birthday": "1990-01-15"}'

# Целевой расчет
curl -X POST http://localhost:3000/api/calc \
  -H "Content-Type: application/json" \
  -d '{"name": "Тест", "birthday": "1990-01-15", "type": "target", "request": "Тестовая цель"}'
```

## Отладка

При проблемах проверьте:

1. **Логи сервера** - все ошибки логируются
2. **Переменные окружения** - убедитесь, что OPENAI_API_KEY установлен
3. **Путь к промптам** - проверьте, что файлы промптов доступны
4. **Формат ответа API** - проверьте логи для формата ответа

## Миграция с n8n

1. Установите `USE_SERVER_GENERATION=true` (по умолчанию)
2. Убедитесь, что `OPENAI_API_KEY` настроен
3. Проверьте, что файлы промптов доступны
4. Протестируйте генерацию всех типов консультаций
5. При необходимости оставьте `N8N_CALC_URL` для fallback

