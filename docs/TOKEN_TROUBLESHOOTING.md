# Устранение проблем с токенами Directus

## Проблема: Токены истекают через 15 минут, несмотря на настройки

Если токены все еще истекают через 15 минут (дефолтное значение), это означает, что настройки `AUTH_TOKEN_TTL` не применяются.

## Пошаговая диагностика

### Шаг 1: Проверьте расположение переменных в docker-compose.yml

Убедитесь, что переменные находятся **ТОЛЬКО** в секции `directus.environment`:

```yaml
directus:
  environment:
    # ... другие переменные ...
    AUTH_TOKEN_TTL: 315360000
    AUTH_REFRESH_TOKEN_TTL: 315360000
```

**НЕ** добавляйте их в:
- ❌ `database.environment`
- ❌ `database.healthcheck`
- ❌ `cache.environment`
- ❌ `cache.healthcheck`

### Шаг 2: Проверьте синтаксис YAML

Убедитесь, что отступы правильные (2 пробела, не табы):

```yaml
directus:
  environment:
    AUTH_TOKEN_TTL: 315360000        # ← правильный отступ (6 пробелов)
    AUTH_REFRESH_TOKEN_TTL: 315360000
```

### Шаг 3: Перезапустите контейнер

```bash
docker-compose down
docker-compose up -d
```

### Шаг 4: Проверьте, что переменные переданы в контейнер

```bash
docker-compose exec directus env | grep AUTH_TOKEN
```

**Ожидаемый результат**:
```
AUTH_TOKEN_TTL=315360000
AUTH_REFRESH_TOKEN_TTL=315360000
```

**Если переменных нет** → они не были переданы в контейнер. Проверьте шаги 1-2.

### Шаг 5: Проверьте логи Directus

```bash
docker-compose logs directus | grep -i "auth\|token\|ttl"
```

Ищите сообщения о применении настроек токенов.

### Шаг 6: Проверьте в Directus UI

1. Зайдите в Directus
2. Settings → Environment → Auth
3. Найдите `AUTH_TOKEN_TTL` и `AUTH_REFRESH_TOKEN_TTL`
4. Убедитесь, что значения правильные (315360000)

**Если значения не отображаются или старые** → переменные не применились.

### Шаг 7: ВАЖНО - Перелогиньтесь!

**Токены, созданные ДО изменения настроек, будут иметь старый TTL (15 минут).**

После перезапуска контейнера:
1. Выйдите из системы
2. Войдите заново
3. Новые токены будут иметь TTL 10 лет

### Шаг 8: Проверьте новый токен

После перелогина проверьте JWT токен:
- `iat` (issued at) - время создания
- `exp` (expiration) - время истечения

Разница должна быть ~315360000 секунд (10 лет), а не 900 секунд (15 минут).

## Альтернативные решения

### Решение 1: Использование .env файла

Если переменные не работают напрямую в docker-compose.yml, попробуйте через .env:

1. Создайте/отредактируйте `.env` файл:
```env
AUTH_TOKEN_TTL=315360000
AUTH_REFRESH_TOKEN_TTL=315360000
```

2. В docker-compose.yml используйте переменные:
```yaml
directus:
  environment:
    AUTH_TOKEN_TTL: ${AUTH_TOKEN_TTL}
    AUTH_REFRESH_TOKEN_TTL: ${AUTH_REFRESH_TOKEN_TTL}
```

### Решение 2: Проверка версии Directus

Убедитесь, что версия Directus поддерживает эти переменные:
- Directus 11.x: ✅ Поддерживается
- Directus 10.x: ✅ Поддерживается
- Directus 9.x: ⚠️ Может не поддерживаться

### Решение 3: Прямая установка через Directus UI

1. Зайдите в Directus UI
2. Settings → Environment → Auth
3. Установите значения напрямую в UI
4. Сохраните и перезапустите контейнер

**Примечание**: Настройки из UI могут не сохраняться после перезапуска, если они не в docker-compose.yml.

## Проверка работы

После всех шагов создайте новый токен и проверьте:

```javascript
// Декодируйте JWT токен (можно использовать jwt.io)
{
  "iat": 1763102063,  // Время создания
  "exp": 3418462063   // Время истечения (должно быть через 10 лет)
}
```

Разница: `exp - iat = 315360000` секунд = 10 лет ✅

Если разница = 900 секунд (15 минут) → настройки не применились ❌

## Частые ошибки

1. **Переменные в неправильной секции** - самая частая ошибка
2. **Неправильные отступы YAML** - используйте 2 пробела
3. **Не перезапустили контейнер** - изменения не применятся без перезапуска
4. **Используют старый токен** - нужно перелогиниться
5. **Опечатки в названиях** - `AUTH_TOKEN_TTL`, а не `AUTH_TOKEN_TTL_` или `AUTH_TOKEN_TTL_`

## Если ничего не помогает

1. Проверьте документацию Directus: https://docs.directus.io/self-hosted/config-options.html#auth
2. Попробуйте пересоздать контейнер (осторожно: удалит данные, если volumes не настроены):
   ```bash
   docker-compose down -v
   docker-compose up -d
   ```
3. Проверьте версию Directus и обновите, если нужно

