# Чеклист проверки настроек консультаций в Directus

## Проблема: "Консультация не найдена или у вас нет прав доступа"

### Шаг 1: Проверка существования коллекции `consultations`

1. Откройте Directus Admin Panel
2. Перейдите в **Settings** → **Data Model**
3. Убедитесь, что коллекция **`consultations`** существует
4. Если коллекции нет — создайте её

---

### Шаг 2: Проверка поля `owner_user` в коллекции `consultations`

1. Откройте коллекцию **`consultations`**
2. Перейдите в **Fields**
3. Убедитесь, что поле **`owner_user`** существует
4. Проверьте настройки поля:
   - **Type**: `Many to One (M2O)`
   - **Collection**: `directus_users`
   - **Required**: ✅ Должно быть включено
   - **Interface**: `Select Dropdown` или `User`

---

### Шаг 3: Проверка Permissions (Права доступа)

1. Перейдите в **Settings** → **Roles & Permissions**
2. Выберите роль, которую использует ваш пользователь (обычно `master` или `Authenticated`)
3. Найдите коллекцию **`consultations`**
4. Проверьте права для действий **Read**, **Create**, **Update**, **Delete**:

#### Для действия **Read**:
- **Permissions** должны быть:
  ```json
  {
    "_and": [
      {
        "owner_user": {
          "_eq": "$CURRENT_USER"
        }
      }
    ]
  }
  ```

#### Для действия **Create**:
- **Validation** должна быть:
  ```json
  {
    "owner_user": {
      "_eq": "$CURRENT_USER"
    }
  }
  ```
- **Presets** должны быть:
  ```json
  {
    "owner_user": "$CURRENT_USER"
  }
  ```

#### Для действий **Update** и **Delete**:
- **Permissions** должны быть такими же, как для **Read**

---

### Шаг 4: Проверка конкретной консультации

1. Перейдите в коллекцию **`consultations`**
2. Найдите консультацию с ID 41 (или проблемную)
3. Проверьте:
   - Существует ли запись?
   - Заполнено ли поле **`owner_user`**?
   - Какой ID пользователя в поле **`owner_user`**?

---

### Шаг 5: Проверка текущего пользователя

1. В приложении откройте консоль браузера (F12)
2. Выполните запрос к `/api/consultations/41` (или проблемной консультации)
3. Проверьте ответ — возможно там есть детали ошибки

Или проверьте в Directus:
1. Перейдите в **Settings** → **Users & Roles**
2. Найдите вашего пользователя
3. Запомните его **ID**
4. Сравните с `owner_user` в консультации

---

### Шаг 6: Проверка через API напрямую

Попробуйте получить консультацию напрямую через Directus API:

```bash
curl -X GET "https://your-directus-url.com/items/consultations/41" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Accept: application/json"
```

Если запрос возвращает 404 или пустой ответ — проблема в правах доступа.

---

### Шаг 7: Временное отключение фильтрации (для диагностики)

**⚠️ ВНИМАНИЕ: Только для диагностики! Не оставляйте так в продакшене!**

1. В Directus перейдите в **Settings** → **Roles & Permissions**
2. Для роли вашего пользователя найдите **`consultations`**
3. Для действия **Read** временно установите **Permissions** в `{}` (пустой объект)
4. Попробуйте получить консультацию снова
5. Если работает — проблема точно в permissions
6. **Обязательно верните правильные permissions обратно!**

---

### Шаг 8: Перезапуск настроек через API

Если у вас есть endpoint `/api/setup`, попробуйте запустить его:

```bash
curl -X POST "https://your-app-url.com/api/setup?force=true" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

Это пересоздаст все permissions согласно коду.

---

### Шаг 9: Проверка через скрипт настройки

Если у вас есть скрипт `scripts/setup-directus-permissions.mjs`, запустите его:

```bash
node scripts/setup-directus-permissions.mjs
```

Это настроит все permissions правильно.

---

## Типичные проблемы и решения

### Проблема 1: Поле `owner_user` не заполнено
**Решение**: При создании консультации должно автоматически проставляться через presets. Проверьте presets в permissions.

### Проблема 2: `owner_user` заполнен другим пользователем
**Решение**: Либо измените `owner_user` вручную в Directus, либо удалите и создайте консультацию заново.

### Проблема 3: Permissions настроены неправильно
**Решение**: Используйте скрипт настройки или endpoint `/api/setup` для автоматической настройки.

### Проблема 4: Роль пользователя не имеет прав
**Решение**: Убедитесь, что пользователь имеет роль с правильными permissions (обычно `master`).

---

## Быстрая проверка через Directus UI

1. Откройте Directus Admin Panel
2. Перейдите в коллекцию **`consultations`**
3. Попробуйте открыть консультацию с ID 41
4. Если видите консультацию — проблема в API коде
5. Если не видите — проблема в permissions

---

## Контрольный список

- [ ] Коллекция `consultations` существует
- [ ] Поле `owner_user` существует и настроено правильно
- [ ] Permissions для `Read` содержат фильтр по `owner_user`
- [ ] Presets для `Create` автоматически проставляют `owner_user`
- [ ] Validation для `Create` проверяет `owner_user`
- [ ] Консультация с ID 41 существует
- [ ] В консультации заполнено поле `owner_user`
- [ ] `owner_user` в консультации совпадает с ID текущего пользователя
- [ ] Роль пользователя имеет правильные permissions
