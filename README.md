# SAL App Starter (Next.js + Directus + n8n + PostgreSQL)

–ì–æ—Ç–æ–≤—ã–π —Å—Ç–∞—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ–¥ —Ç–≤–æ–π —Å–µ—Ä–≤–∏—Å –°–ê–õ:

- **Next.js (App Router, TS, Tailwind)** ‚Äî —Ñ—Ä–æ–Ω—Ç –∏ API-–ø—Ä–æ–∫—Å–∏
- **Directus** ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Ä–æ–ª–∏, –¥–æ—Å—Ç—É–ø –∫ –ë–î
- **n8n** ‚Äî —Ä–∞—Å—á—ë—Ç –ø—Ä–æ—Ñ–∏–ª—è –∏ Q&A –ø–æ –ø—Ä–æ—Ñ–∏–ª—é
- **PostgreSQL** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1) –°–∫–ª–æ–Ω–∏—Ä—É–π –∏ —É—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
pnpm i # –∏–ª–∏ npm i / yarn
```

2) –ó–∞–ø–æ–ª–Ω–∏ `.env` –ø–æ –æ–±—Ä–∞–∑—Ü—É `.env.example`:
- `DIRECTUS_URL` –∏–ª–∏ `NEXT_PUBLIC_DIRECTUS_URL` ‚Äî URL —Ç–≤–æ–µ–≥–æ Directus
- `N8N_CALC_URL` ‚Äî –≤–µ–±—Ö—É–∫ n8n –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è
- `N8N_QA_URL` ‚Äî –≤–µ–±—Ö—É–∫ n8n –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤

3) –ó–∞–ø—É—Å—Ç–∏ dev-—Å–µ—Ä–≤–µ—Ä
```bash
pnpm dev # http://localhost:3000
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

- `/api/login` ‚Üí –ø—Ä–æ–∫—Å–∏ –∫ `POST {DIRECTUS_URL}/auth/login`, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `directus_access_token` –∏ `directus_refresh_token` –≤ **httpOnly** cookies.
- `/api/logout` ‚Üí –æ—á–∏—â–∞–µ—Ç cookies.
- Protected-—Ä–æ—É—Ç—ã (–≤—Å–µ –ø–æ–¥ `(protected)`) –ø—Ä–æ–≤–µ—Ä—è—é—Ç cookie –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç—è—Ç –Ω–∞ `/login` –ø—Ä–∏ –µ—ë –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏.

## –î–∞–Ω–Ω—ã–µ

- –§—Ä–æ–Ω—Ç –Ω–µ —Ö–æ–¥–∏—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ Directus: –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ —Ä–æ—É—Ç—ã `/api/*`, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization.
- –ü—Ä–æ—Ñ–∏–ª–∏: `/api/profiles` –∏ `/api/profiles/[id]` –ø—Ä–æ–∫—Å–∏—Ä—É—é—Ç –∫ Directus Items API.
- –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è: `/api/calc` –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ —Ç–≤–æ–π n8n-–≤–µ–±—Ö—É–∫ `calc-profile` (–æ–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ n8n —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å–∏ –≤ –ë–î/Directus).
- –í–æ–ø—Ä–æ—Å—ã: `/api/qa` ‚Üí —Ç–≤–æ–π n8n-–≤–µ–±—Ö—É–∫ `qa` (—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º).

## –ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Directus

- –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫ —Ç–≤–æ–µ–π PostgreSQL —Å–æ —Å—Ö–µ–º–æ–π `clients`, `profiles`, `profile_chunks`, `qa` (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø—Ä—è–º–æ –≤ Directus ‚Äî –ø–æ–ª—è –º–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ç–∞–±–ª–∏—Ü–∞–º).
- –í–∫–ª—é—á–∏—Ç—å Email/Password auth –∏ SMTP.
- –°–æ–∑–¥–∞—Ç—å —Ä–æ–ª–∏:
  - `master` ‚Äî –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ **—Å–≤–æ–∏–º** `profiles`/`qa` –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º `clients`.
- –í Permissions –∑–∞–¥–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã `user_created = $CURRENT_USER` (–∏–ª–∏ —Ç–≤–æ–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑—ã–≤–∞–Ω–∏—è).
- (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–æ–∫–µ–Ω –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤.

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ n8n (–º–∏–Ω–∏–º—É–º)

- –í –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤–æ—Ä–∫—Ñ–ª–æ—É (`calc-profile`, `qa`) ‚Äî –Ω–æ–¥–∞, –∫–æ—Ç–æ—Ä–∞—è:
  - –ß–∏—Ç–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <directus_access_token>`,
  - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–º `GET {DIRECTUS_URL}/users/me`,
  - –ï—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω ‚Äî 401.
- `calc-profile`: –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã (–∏–º—è, –¥–∞—Ç–∞ –∏ —Ç.–¥.), –≤—ã–∑—ã–≤–∞–µ—Ç –ò–ò, –ø–∏—à–µ—Ç –≤ `profiles` (–∏ `profile_chunks`/`profile_embeddings` –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ profileId }`.
- `qa`: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `{ profileId, question }`, –¥–æ—Å—Ç–∞—ë—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (pgvector/FTS), –∑–æ–≤—ë—Ç –ò–ò, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `qa`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ answer }`.

## –î–µ–ø–ª–æ–π –≤ CapRover

- –°–æ–±–µ—Ä–∏ –æ–±—Ä–∞–∑ Next: `docker build -t sal-app-starter .` (—Å–æ–∑–¥–∞–π Dockerfile –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –¥–µ–ø–ª–æ–π –∏–∑ GitHub –ø–æ buildpack).
- –ü—Ä–æ–ø–∏—à–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–∞–∫ –≤ `.env.example`.
- –ü—Ä–æ–∫—Å–∏—Ä—É–π —á–µ—Ä–µ–∑ HTTPS.

## –î–∞–ª—å—à–µ

- –î–æ–±–∞–≤—å —Ñ–æ—Ä–º—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–∞—Å—á—ë—Ç–∞ (–∏–º—è, –¥–∞—Ç–∞, —Ç.–ø.) –Ω–∞ `/profiles` ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–π –≤ `/api/calc`.
- –†–µ–Ω–¥–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è: —Å–µ–π—á–∞—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è HTML, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å –≤ Directus. –ú–æ–∂–Ω–æ –µ—â—ë —Ä–∏—Å–æ–≤–∞—Ç—å ¬´–∂–∏–≤—ã–µ¬ª –±–ª–æ–∫–∏ –∏–∑ `raw_json`.
- –ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞: —Å–¥–µ–ª–∞–π —Å—Ç—Ä–∞–Ω–∏—Ü—É `/clients/[id]` –∏ –≤—ã–≤–æ–¥ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `qa` —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `profile_id`.

–£–¥–∞—á–∏! üöÄ
